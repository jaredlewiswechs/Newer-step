<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyTalk IDE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent: #58a6ff;
            --accent-hover: #79c0ff;
            --success: #3fb950;
            --error: #f85149;
            --warning: #d29922;
            --purple: #bc8cff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-icon {
            font-size: 16px;
        }

        /* Select */
        .select-wrapper {
            position: relative;
        }

        .select {
            font-family: inherit;
            font-size: 13px;
            padding: 8px 32px 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            min-width: 160px;
        }

        .select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .select-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-secondary);
        }

        /* Main Layout */
        .main {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .example-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .example-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .example-item.active {
            background: rgba(88, 166, 255, 0.1);
            color: var(--accent);
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .file-icon {
            color: var(--accent);
        }

        .file-name {
            color: var(--text-primary);
        }

        .editor-wrapper {
            flex: 1;
            min-height: 0;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        /* Output Panel */
        .output-panel {
            width: 400px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .output-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .output-title {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .output-title-icon {
            font-size: 16px;
        }

        .status-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-success {
            background: rgba(63, 185, 80, 0.15);
            color: var(--success);
        }

        .status-error {
            background: rgba(248, 81, 73, 0.15);
            color: var(--error);
        }

        .status-running {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent);
        }

        .output-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .output-section {
            margin-bottom: 16px;
        }

        .output-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .output-text {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .output-text.error {
            border-color: var(--error);
            color: var(--error);
        }

        .output-text.success {
            border-color: var(--success);
        }

        .output-meta {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .meta-item {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .meta-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Splash / Welcome */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .welcome-text {
            font-size: 14px;
            max-width: 280px;
        }

        /* Keyboard shortcuts */
        kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 200px;
            }
            .output-panel {
                width: 320px;
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }
        }

        /* Loading animation */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">Tt</div>
            <div>
                <div class="logo-text">TinyTalk</div>
                <div class="logo-subtitle">Verified General-Purpose Language</div>
            </div>
        </div>
        <div class="header-actions">
            <div class="select-wrapper">
                <select class="select" id="exampleSelect">
                    <option value="">Load Example...</option>
                </select>
                <span class="select-arrow">‚ñº</span>
            </div>
            <button class="btn btn-primary" id="runBtn" onclick="runCode()">
                <span class="btn-icon">‚ñ∂</span>
                Run
                <kbd>Ctrl+Enter</kbd>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">üìö Examples</div>
            <div class="sidebar-content" id="examplesList">
                <!-- Examples loaded dynamically -->
            </div>
        </aside>

        <!-- Editor -->
        <div class="editor-container">
            <div class="editor-header">
                <span class="file-icon">üìÑ</span>
                <span class="file-name">untitled.tt</span>
            </div>
            <div class="editor-wrapper">
                <div id="editor"></div>
            </div>
        </div>

        <!-- Output Panel -->
        <aside class="output-panel">
            <div class="output-header">
                <div class="output-title">
                    <span class="output-title-icon">üì§</span>
                    Output
                </div>
                <span class="status-badge" id="statusBadge"></span>
            </div>
            <div class="output-content" id="outputContent">
                <div class="welcome">
                    <div class="welcome-icon">üöÄ</div>
                    <div class="welcome-text">
                        Write some TinyTalk code and press <kbd>Ctrl+Enter</kbd> or click <strong>Run</strong> to execute.
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script>
        let editor;
        let examples = [];

        // Initialize Monaco
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            // Register TinyTalk language
            monaco.languages.register({ id: 'tinytalk' });

            // TinyTalk syntax highlighting
            monaco.languages.setMonarchTokensProvider('tinytalk', {
                keywords: [
                    'let', 'const', 'fn', 'return', 'if', 'else', 'for', 'while', 'in',
                    'break', 'continue', 'true', 'false', 'null', 'and', 'or', 'not',
                    'struct', 'enum', 'import', 'from', 'as', 'match', 'try', 'catch',
                    'throw', 'async', 'await', 'yield'
                ],
                builtins: [
                    'print', 'println', 'len', 'type', 'str', 'int', 'float', 'bool',
                    'range', 'append', 'keys', 'values', 'items', 'sum', 'min', 'max',
                    'abs', 'sqrt', 'pow', 'sin', 'cos', 'tan', 'floor', 'ceil', 'round',
                    'filter', 'map', 'reduce', 'sort', 'reverse', 'join', 'split',
                    'slice', 'contains', 'find', 'replace', 'upper', 'lower', 'trim',
                    'startswith', 'endswith', 'input', 'assert', 'exit', 'time'
                ],
                operators: [
                    '=', '>', '<', '!', '==', '<=', '>=', '!=',
                    '+', '-', '*', '/', '%', '**',
                    '&&', '||', '|>', '..', '..='
                ],
                symbols: /[=><!~?:&|+\-*\/\^%]+/,

                tokenizer: {
                    root: [
                        // Comments
                        [/\/\/.*$/, 'comment'],
                        [/\/\*/, 'comment', '@comment'],

                        // Strings
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/"/, 'string', '@string'],
                        [/'([^'\\]|\\.)*$/, 'string.invalid'],
                        [/'/, 'string', '@stringSingle'],

                        // Numbers
                        [/\d+\.\d+([eE][\-+]?\d+)?/, 'number.float'],
                        [/0[xX][0-9a-fA-F]+/, 'number.hex'],
                        [/0[bB][01]+/, 'number.binary'],
                        [/\d+/, 'number'],

                        // Keywords
                        [/[a-zA-Z_]\w*/, {
                            cases: {
                                '@keywords': 'keyword',
                                '@builtins': 'predefined',
                                '@default': 'identifier'
                            }
                        }],

                        // Operators
                        [/@symbols/, {
                            cases: {
                                '@operators': 'operator',
                                '@default': ''
                            }
                        }],

                        // Brackets
                        [/[{}()\[\]]/, '@brackets'],
                        [/[;,.]/, 'delimiter'],
                    ],

                    comment: [
                        [/[^\/*]+/, 'comment'],
                        [/\*\//, 'comment', '@pop'],
                        [/[\/*]/, 'comment']
                    ],

                    string: [
                        [/[^\\"]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/"/, 'string', '@pop']
                    ],

                    stringSingle: [
                        [/[^\\']+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/'/, 'string', '@pop']
                    ]
                }
            });

            // Define theme
            monaco.editor.defineTheme('tinytalk-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'keyword', foreground: 'ff7b72', fontStyle: 'bold' },
                    { token: 'predefined', foreground: 'd2a8ff' },
                    { token: 'string', foreground: 'a5d6ff' },
                    { token: 'string.escape', foreground: '79c0ff' },
                    { token: 'number', foreground: '79c0ff' },
                    { token: 'number.float', foreground: '79c0ff' },
                    { token: 'number.hex', foreground: '79c0ff' },
                    { token: 'comment', foreground: '8b949e', fontStyle: 'italic' },
                    { token: 'operator', foreground: 'ff7b72' },
                    { token: 'identifier', foreground: 'f0f6fc' },
                ],
                colors: {
                    'editor.background': '#0d1117',
                    'editor.foreground': '#f0f6fc',
                    'editor.lineHighlightBackground': '#161b22',
                    'editor.selectionBackground': '#264f78',
                    'editorCursor.foreground': '#58a6ff',
                    'editorLineNumber.foreground': '#6e7681',
                    'editorLineNumber.activeForeground': '#f0f6fc',
                }
            });

            // Create editor
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: `// Welcome to TinyTalk!
// A verified general-purpose programming language

fn greet(name) {
    return "Hello, " + name + "!"
}

let message = greet("World")
println(message)

// Try some math
let x = 10
let y = 20
println("x + y = " + str(x + y))

// Fibonacci example
fn fib(n) {
    if n <= 1 {
        return n
    }
    return fib(n - 1) + fib(n - 2)
}

println("")
println("Fibonacci numbers:")
for i in range(10) {
    println("fib(" + str(i) + ") = " + str(fib(i)))
}`,
                language: 'tinytalk',
                theme: 'tinytalk-dark',
                fontFamily: "'JetBrains Mono', Consolas, monospace",
                fontSize: 14,
                lineHeight: 24,
                padding: { top: 16, bottom: 16 },
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                renderLineHighlight: 'all',
                cursorBlinking: 'smooth',
                smoothScrolling: true,
                tabSize: 4,
                insertSpaces: true,
                automaticLayout: true,
            });

            // Keyboard shortcut: Ctrl+Enter to run
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runCode);

            // Auto-completion
            monaco.languages.registerCompletionItemProvider('tinytalk', {
                provideCompletionItems: (model, position) => {
                    const suggestions = [
                        // Keywords
                        ...['let', 'const', 'fn', 'return', 'if', 'else', 'for', 'while', 'in', 'true', 'false', 'null', 'and', 'or', 'not'].map(k => ({
                            label: k,
                            kind: monaco.languages.CompletionItemKind.Keyword,
                            insertText: k,
                        })),
                        // Builtins
                        ...['print', 'println', 'len', 'type', 'str', 'int', 'float', 'bool', 'range', 'append', 'sum', 'min', 'max', 'abs', 'sqrt', 'pow'].map(b => ({
                            label: b,
                            kind: monaco.languages.CompletionItemKind.Function,
                            insertText: b + '($0)',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        })),
                        // Snippets
                        {
                            label: 'fn',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'fn ${1:name}(${2:params}) {\n\t$0\n}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Function definition'
                        },
                        {
                            label: 'for',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'for ${1:i} in ${2:range(10)} {\n\t$0\n}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'For loop'
                        },
                        {
                            label: 'if',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'if ${1:condition} {\n\t$0\n}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'If statement'
                        },
                        {
                            label: 'while',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'while ${1:condition} {\n\t$0\n}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'While loop'
                        },
                    ];
                    return { suggestions };
                }
            });
        });

        // Load examples
        async function loadExamples() {
            try {
                const response = await fetch('/api/examples');
                examples = await response.json();
                
                // Populate sidebar
                const list = document.getElementById('examplesList');
                list.innerHTML = examples.map((ex, i) => `
                    <div class="example-item" onclick="loadExample(${i})">${ex.name}</div>
                `).join('');

                // Populate dropdown
                const select = document.getElementById('exampleSelect');
                select.innerHTML = '<option value="">Load Example...</option>' +
                    examples.map((ex, i) => `<option value="${i}">${ex.name}</option>`).join('');
            } catch (err) {
                console.error('Failed to load examples:', err);
            }
        }

        function loadExample(index) {
            const example = examples[index];
            if (example && editor) {
                editor.setValue(example.code);
                // Update active state
                document.querySelectorAll('.example-item').forEach((el, i) => {
                    el.classList.toggle('active', i === index);
                });
                document.getElementById('exampleSelect').value = index;
            }
        }

        // Handle dropdown change
        document.getElementById('exampleSelect').addEventListener('change', (e) => {
            if (e.target.value !== '') {
                loadExample(parseInt(e.target.value));
            }
        });

        // Run code
        async function runCode() {
            const code = editor.getValue();
            const runBtn = document.getElementById('runBtn');
            const statusBadge = document.getElementById('statusBadge');
            const outputContent = document.getElementById('outputContent');

            // Update UI to running state
            runBtn.disabled = true;
            runBtn.innerHTML = '<div class="spinner"></div> Running...';
            statusBadge.className = 'status-badge status-running';
            statusBadge.textContent = 'Running...';

            try {
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const result = await response.json();

                // Update status
                if (result.success) {
                    statusBadge.className = 'status-badge status-success';
                    statusBadge.textContent = 'Success';
                } else {
                    statusBadge.className = 'status-badge status-error';
                    statusBadge.textContent = 'Error';
                }

                // Build output HTML
                let html = '';

                if (result.output) {
                    html += `
                        <div class="output-section">
                            <div class="output-label">Output</div>
                            <div class="output-text">${escapeHtml(result.output)}</div>
                        </div>
                    `;
                }

                if (result.result) {
                    html += `
                        <div class="output-section">
                            <div class="output-label">Result</div>
                            <div class="output-text success">${escapeHtml(result.result)}</div>
                        </div>
                    `;
                }

                if (result.error) {
                    html += `
                        <div class="output-section">
                            <div class="output-label">Error</div>
                            <div class="output-text error">${escapeHtml(result.error)}</div>
                        </div>
                    `;
                }

                if (!result.output && !result.result && !result.error) {
                    html += `
                        <div class="output-section">
                            <div class="output-text" style="color: var(--text-muted);">No output</div>
                        </div>
                    `;
                }

                html += `
                    <div class="output-meta">
                        <div class="meta-item">
                            ‚è±Ô∏è <span class="meta-value">${result.elapsed_ms}ms</span>
                        </div>
                        <div class="meta-item">
                            ‚úì <span class="meta-value">Verified</span>
                        </div>
                    </div>
                `;

                outputContent.innerHTML = html;

            } catch (err) {
                statusBadge.className = 'status-badge status-error';
                statusBadge.textContent = 'Error';
                outputContent.innerHTML = `
                    <div class="output-section">
                        <div class="output-label">Error</div>
                        <div class="output-text error">Failed to connect to server: ${escapeHtml(err.message)}</div>
                    </div>
                `;
            }

            // Reset button
            runBtn.disabled = false;
            runBtn.innerHTML = '<span class="btn-icon">‚ñ∂</span> Run <kbd>Ctrl+Enter</kbd>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadExamples();
    </script>
</body>
</html>
